#!/bin/bash

# Check if running on Fedora
if [ ! -f /etc/fedora-release ]; then
    echo -e "\e[31mThis script is intended for use on Fedora Linux.\e[0m"
    exit 1
fi

# Function to run commands with sudo if not root
run_with_sudo() {
    if [ "$EUID" -ne 0 ]; then
        sudo "$@"
    else
        "$@"
    fi
}

# Prompt for BOT name
echo -e "\e[36mGreetings Master Mulandi🫠. Enter a name for your BOT (e.g., levanter):\e[0m"
read -r BOT_NAME
BOT_NAME=${BOT_NAME:-levanter}

# Handle existing directory
if [ -d "$BOT_NAME" ]; then
    RANDOM_SUFFIX=$((1 + RANDOM % 1000))
    BOT_NAME="${BOT_NAME}${RANDOM_SUFFIX}"
    echo -e "\e[33mFolder with the same name exists. Renaming to $BOT_NAME.\e[0m"
fi

# Prompt for SESSION_ID
echo -e "\e[36mDo you have a SESSION_ID scanned today? (y/n):\e[0m"
read -r HAS_SESSION_ID
SESSION_ID=""
if [[ "$HAS_SESSION_ID" == "y" ]]; then
    echo -e "\e[36mNice😉, now enter your SESSION_ID:\e[0m"
    read -r SESSION_ID
fi

# Function to install Node.js
install_nodejs() {
    echo -e "\e[33mInstalling Node.js version 20...\e[0m"
    curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
    if ! run_with_sudo dnf install -y nodejs; then
        echo -e "\e[31mFailed to install Node.js.\e[0m"
        exit 1
    fi
}

# Function to uninstall Node.js
uninstall_nodejs() {
    echo -e "\e[33mRemoving existing Node.js installation...\e[0m"
    run_with_sudo dnf remove -y nodejs
    run_with_sudo dnf autoremove -y
}

# Update system packages
echo -e "\e[33mUpdating system packages...\e[0m"
if ! run_with_sudo dnf update -y; then
    echo -e "\e[31mFailed to update system packages.\e[0m"
    exit 1
fi

# Install required packages
for pkg in git ffmpeg curl; do
    if ! command -v "$pkg" &> /dev/null; then
        if ! run_with_sudo dnf install -y "$pkg"; then
            echo -e "\e[31mFailed to install $pkg.\e[0m"
            exit 1
        fi
    fi
done

# Check for Node.js version and reinstall if necessary
if command -v node &> /dev/null; then
    CURRENT_NODE_VERSION=$(node -v | cut -d. -f1)
    if [[ "$CURRENT_NODE_VERSION" != "v20" ]]; then
        uninstall_nodejs
        install_nodejs
    else
        echo -e "\e[32mNode.js version 20 is already installed.\e[0m"
    fi
else
    install_nodejs
fi

# Check and install Yarn
YARN_REQUIRED_VERSION="1"
if command -v yarn &> /dev/null; then
    CURRENT_YARN_VERSION=$(yarn -v | cut -d. -f1)
    if [[ "$CURRENT_YARN_VERSION" != "$YARN_REQUIRED_VERSION" ]]; then
        echo -e "\e[33mRemoving existing Yarn installation...\e[0m"
        run_with_sudo npm uninstall -g yarn
        echo -e "\e[33mInstalling Yarn...\e[0m"
        run_with_sudo npm install -g yarn
    else
        echo -e "\e[32mYarn is already installed.\e[0m"
    fi
else
    echo -e "\e[33mInstalling Yarn...\e[0m"
    run_with_sudo npm install -g yarn
fi

# Check and install PM2
if ! command -v pm2 &> /dev/null; then
    echo -e "\e[33mInstalling PM2...\e[0m"
    yarn global add pm2
else
    echo -e "\e[32mPM2 is already installed.\e[0m"
fi

# Clone the repository
echo -e "\e[33mCloning Levanter repository...\e[0m"
if ! git clone https://github.com/lyfe00011/levanter.git "$BOT_NAME"; then
    echo -e "\e[31mFailed to clone repository.\e[0m"
    exit 1
fi
cd "$BOT_NAME"

# Install dependencies
echo -e "\e[33mInstalling dependencies with Yarn...\e[0m"
if ! yarn install --network-concurrency 3; then
    echo -e "\e[31mFailed to install dependencies.\e[0m"
    exit 1
fi

# Create config.env file
echo -e "\e[33mCreating config.env file...\e[0m"
cat > config.env <<EOL
PREFIX=null
STICKER_PACKNAME=ᵃᶜᵉ±𝙽𝚢𝚡
ALWAYS_ONLINE=true
RMBG_KEY=null
LANGUAGE=en
WARN_LIMIT=3
FORCE_LOGOUT=false
BRAINSHOP=159501,6pq8dPiYt7PdqHz3
MAX_UPLOAD=60
REJECT_CALL=false
SUDO=null,254768827492
TZ=Africa/Nairobi
ANTI_DELETE=p
VV=P
VPS=true
AUTO_STATUS_VIEW=no-dl
SEND_READ=false
AJOIN=true
STATUS_VIEW_EMOJI=false
BING_COOKIE=false
VV=p
# ⚠️ WARNING: If you're sharing this script, remove your actual Gemini API key!
GEMINI_API_KEY=AIzaSyBS8IDHKR-49k9kB7vMA4moHAZAUR3hA0g
MENTION={ "contextInfo": { "forwardingScore": 5, "isForwarded": false }, "linkPreview": { "head": "𝙷𝚎𝚕𝚕𝚘 𝚝𝚑𝚎𝚛𝚎🍃", "body": " Tap to view👐", "mediaType": 2, "thumbnail": "https://files.catbox.moe/o9bfas.jpeg", "sourceUrl": "https://by-ace.vercel.app/" }, "waveform": [20,5,0,80,80,30,20,50] }
EOL

echo "NAME=$BOT_NAME" >> config.env

if [ -n "$SESSION_ID" ]; then
    echo "SESSION_ID=$SESSION_ID" >> config.env
fi

# Start the bot
echo -e "\e[33mStarting the bot...\e[0m"
if ! pm2 start index.js --name "$BOT_NAME" --attach; then
    echo -e "\e[31mFailed to start the bot.\e[0m"
    exit 1
fi
